{% extends "customer_base.html" %}

{% block title %}Cambiar Método de Pago - ConquerPass{% endblock %}

{% block content %}
<div class="px-4 sm:px-6 lg:px-8">
    <div class="max-w-2xl mx-auto">
        <!-- Contenido completo que se oculta en éxito -->
        <div id="main-content">
            <!-- Header -->
            <div class="mb-8 text-center">
                <h1 class="text-3xl font-bold text-gray-900">
                    <i class="fas fa-credit-card text-stripe-500 mr-3"></i>
                    Configurar Método de Pago
                </h1>
                <p class="mt-3 text-lg text-gray-600">
                    Agrega un nuevo método de pago de forma segura
                </p>
            </div>

            <!-- Información del cliente (simplificada) -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-8">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-info-circle text-blue-400"></i>
                    </div>
                    <div class="ml-3">
                        <div class="text-sm font-medium text-blue-800">
                            Configurando método de pago para: <strong>{{ customer.name|default:customer.email }}</strong>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card principal -->
            <div class="bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden">
                <div class="px-6 py-6">

                    <!-- Error message (solo se muestra si hay error) -->
                    <div id="error-message" class="hidden rounded-md bg-red-50 border border-red-200 p-4 mb-6">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-exclamation-triangle text-red-400"></i>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-red-800">Error</h3>
                                <div class="text-sm text-red-700 mt-1" id="error-text"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Formulario de método de pago -->
                    <form id="payment-form">
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-credit-card mr-2 text-gray-400"></i>
                                Información de la tarjeta
                            </label>
                            <div class="border border-gray-300 rounded-md p-4 bg-white focus-within:ring-1 focus-within:ring-stripe-500 focus-within:border-stripe-500" style="min-height: 50px;">
                                <!-- Stripe Elements se montará aquí -->
                                <div id="card-element">
                                    <!-- Stripe Elements creará los inputs aquí -->
                                </div>
                            </div>
                            <div class="mt-2 text-sm text-gray-500 flex items-center">
                                <i class="fas fa-lock mr-2 text-green-500"></i>
                                Tu información de pago está segura y encriptada
                            </div>
                        </div>

                        <!-- Errores de validación de tarjeta -->
                        <div id="card-errors" class="text-red-600 text-sm mb-4" role="alert"></div>

                        <div class="mt-6">
                            <button type="submit" id="submit-button" class="w-full flex justify-center items-center px-6 py-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-stripe-500 hover:bg-stripe-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-stripe-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-plus-circle mr-3"></i>
                                <span id="button-text">Configurar Método de Pago</span>
                                <div id="spinner" class="hidden ml-3">
                                    <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                                </div>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Información adicional -->
            <div class="mt-6 bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">
                        <i class="fas fa-info-circle text-gray-400 mr-2"></i>
                        Información de Seguridad
                    </h3>
                </div>
                <div class="px-6 py-4">
                    <div class="space-y-3">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <i class="fas fa-shield-alt text-green-500 mt-1"></i>
                            </div>
                            <div class="ml-3">
                                <div class="text-sm font-medium text-gray-900">Procesamiento Seguro</div>
                                <div class="text-sm text-gray-500">Todos los datos son procesados por Stripe con encriptación SSL de nivel bancario</div>
                            </div>
                        </div>
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <i class="fas fa-credit-card text-blue-500 mt-1"></i>
                            </div>
                            <div class="ml-3">
                                <div class="text-sm font-medium text-gray-900">Tarjetas Aceptadas</div>
                                <div class="text-sm text-gray-500">Visa, Mastercard, American Express y más</div>
                            </div>
                        </div>
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <i class="fas fa-ban text-yellow-500 mt-1"></i>
                            </div>
                            <div class="ml-3">
                                <div class="text-sm font-medium text-gray-900">Sin Cargos</div>
                                <div class="text-sm text-gray-500">Solo se guardará el método de pago, no se realizará ningún cobro</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mensaje de éxito (solo se muestra en éxito) -->
        <div id="success-message" class="hidden">
            <div class="text-center py-16">
                <div class="max-w-lg mx-auto">
                    <div class="rounded-full bg-green-100 w-24 h-24 flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-check-circle text-4xl text-green-500"></i>
                    </div>
                    <h2 class="text-3xl font-bold text-gray-900 mb-4">
                        ¡Método de pago actualizado!
                    </h2>
                    <p class="text-lg text-gray-600 mb-8">
                        El nuevo método de pago se ha configurado correctamente y establecido como predeterminado para tu cuenta.
                    </p>
                    <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                        <div class="flex items-center justify-center">
                            <div class="flex-shrink-0">
                                <i class="fas fa-shield-alt text-green-500"></i>
                            </div>
                            <div class="ml-3 text-sm text-green-800">
                                Tu información de pago está segura y lista para usar
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://js.stripe.com/v3/"></script>
<script>
    // Configuración de Stripe
    const stripe = Stripe('{{ stripe_publishable_key }}');
    const elements = stripe.elements();

    // Crear elemento de tarjeta
    const cardElement = elements.create('card', {
        style: {
            base: {
                fontSize: '16px',
                color: '#424770',
                '::placeholder': {
                    color: '#aab7c4',
                },
                fontFamily: 'system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto',
            },
            invalid: {
                color: '#9e2146',
            },
        },
        hidePostalCode: false
    });

    // Montar el elemento en el DOM
    cardElement.mount('#card-element');

    // Manejar errores en tiempo real
    cardElement.on('change', ({ error }) => {
        const displayError = document.getElementById('card-errors');
        if (error) {
            displayError.textContent = error.message;
        } else {
            displayError.textContent = '';
        }
    });

    // Manejar el envío del formulario
    const form = document.getElementById('payment-form');
    const submitButton = document.getElementById('submit-button');
    const buttonText = document.getElementById('button-text');
    const spinner = document.getElementById('spinner');

    form.addEventListener('submit', async (event) => {
        event.preventDefault();

        setLoading(true);

        const { setupIntent, error } = await stripe.confirmCardSetup(
            '{{ setup_intent_client_secret }}',
            {
                payment_method: {
                    card: cardElement,
                }
            }
        );

        if (error) {
            // Mostrar error al usuario
            showError(error.message);
            setLoading(false);
        } else {
            // Setup Intent confirmado exitosamente
            console.log('Setup Intent confirmado:', setupIntent);
            
            // Notificar al servidor sobre el éxito
            try {
                const response = await fetch('{% url "facturacion:cambiar_metodo_pago" customer_email=customer_email %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        setup_intent_id: setupIntent.id
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showSuccess();
                } else {
                    showError(result.error);
                }
            } catch (fetchError) {
                showError('Error al procesar la respuesta del servidor');
                console.error('Error:', fetchError);
            }
            
            setLoading(false);
        }
    });

    function setLoading(isLoading) {
        if (isLoading) {
            submitButton.disabled = true;
            buttonText.textContent = 'Procesando...';
            spinner.classList.remove('hidden');
        } else {
            submitButton.disabled = false;
            buttonText.textContent = 'Configurar Método de Pago';
            spinner.classList.add('hidden');
        }
    }

    function showError(message) {
        const errorDiv = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const successDiv = document.getElementById('success-message');
        
        successDiv.classList.add('hidden');
        errorText.textContent = message;
        errorDiv.classList.remove('hidden');
        
        // Scroll al error
        errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function showSuccess() {
        const errorDiv = document.getElementById('error-message');
        const successDiv = document.getElementById('success-message');
        const mainContent = document.getElementById('main-content');
        
        // Ocultar mensaje de error si está visible
        errorDiv.classList.add('hidden');
        
        // Ocultar todo el contenido principal
        mainContent.classList.add('hidden');
        
        // Mostrar mensaje de éxito
        successDiv.classList.remove('hidden');
        
        // Scroll al éxito
        successDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
</script>
{% endblock %}