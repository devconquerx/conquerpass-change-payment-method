{% extends 'base.html' %}

{% block title %}Lista de Clientes - ConquerPass{% endblock %}

{% block nav_actions %}
<span class="text-sm text-gray-500">
    <i class="fab fa-stripe mr-1"></i>
    Powered by Stripe
</span>
{% endblock %}

{% block footer_left %}
© 2024 ConquerPass. Dashboard de Stripe.
{% endblock %}

{% block content %}
<div class="px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="sm:flex sm:items-center">
        <div class="sm:flex-auto">
            <h1 class="text-2xl font-bold leading-6 text-gray-900">
                <i class="fas fa-users text-stripe-500 mr-3"></i>
                Lista de Clientes de Stripe
            </h1>
            <p class="mt-2 text-sm text-gray-700">
                Gestiona y visualiza todos los clientes registrados en tu cuenta de Stripe
            </p>
        </div>
        <div class="mt-4 sm:ml-16 sm:mt-0 sm:flex-none">
            <button type="button" 
                    onclick="location.reload()"
                    class="block rounded-md bg-stripe-500 px-3 py-2 text-center text-sm font-semibold text-white shadow-sm hover:bg-stripe-600 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-stripe-500 transition-colors">
                <i class="fas fa-sync-alt mr-2"></i>
                Actualizar
            </button>
        </div>
    </div>
    
    <!-- Filtros -->
    <div class="mt-8 bg-white rounded-lg shadow-sm border border-gray-200">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-medium text-gray-900">
                <i class="fas fa-filter text-gray-400 mr-2"></i>
                Filtros de Búsqueda
            </h3>
        </div>
        <div class="p-6">
            <form method="GET" id="filterForm" class="space-y-4 sm:space-y-0 sm:flex sm:items-end sm:space-x-4">
                <div class="flex-1">
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">
                        Email del Cliente
                    </label>
                    <div class="relative">
                        <input 
                            type="email" 
                            name="email" 
                            id="email"
                            placeholder="Buscar por email..." 
                            value="{{ email_filter|default:'' }}"
                            class="block w-full rounded-md border-gray-300 shadow-sm focus:border-stripe-500 focus:ring-stripe-500 pl-10 sm:text-sm"
                        >
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-envelope text-gray-400"></i>
                        </div>
                    </div>
                </div>
                
                <div class="sm:w-48">
                    <label for="limit" class="block text-sm font-medium text-gray-700 mb-1">
                        Elementos por página
                    </label>
                    <select name="limit" id="limit" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-stripe-500 focus:ring-stripe-500 sm:text-sm">
                        <option value="5" {% if limit == 5 %}selected{% endif %}>5 por página</option>
                        <option value="10" {% if limit == 10 %}selected{% endif %}>10 por página</option>
                        <option value="20" {% if limit == 20 %}selected{% endif %}>20 por página</option>
                        <option value="50" {% if limit == 50 %}selected{% endif %}>50 por página</option>
                    </select>
                </div>
                
                <div class="flex space-x-3">
                    <button type="submit" 
                            class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-stripe-500 hover:bg-stripe-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-stripe-500 transition-colors">
                        <i class="fas fa-search mr-2"></i>
                        Filtrar
                    </button>
                    <button type="button" 
                            onclick="clearFilters()"
                            class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-stripe-500 transition-colors">
                        <i class="fas fa-times mr-2"></i>
                        Limpiar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Loading indicator -->
    <div id="loading" class="hidden mt-8 text-center py-12">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-stripe-500"></div>
        <p class="mt-2 text-sm text-gray-600">Cargando clientes...</p>
    </div>

    <!-- Error message -->
    <div id="errorMessage" class="hidden mt-4 rounded-md bg-red-50 border border-red-200 p-4">
        <div class="flex">
            <div class="flex-shrink-0">
                <i class="fas fa-exclamation-triangle text-red-400"></i>
            </div>
            <div class="ml-3">
                <p class="text-sm text-red-800"></p>
            </div>
        </div>
    </div>

    <!-- Tabla de clientes -->
    <div id="customersContainer" class="mt-8">
        {% if customers %}
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">
                    <i class="fas fa-table text-gray-400 mr-2"></i>
                    Clientes ({{ customers|length }})
                </h3>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <i class="fas fa-id-card mr-1"></i>
                                ID Cliente
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <i class="fas fa-user mr-1"></i>
                                Nombre
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <i class="fas fa-envelope mr-1"></i>
                                Email
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <i class="fas fa-phone mr-1"></i>
                                Teléfono
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <i class="fas fa-info-circle mr-1"></i>
                                Descripción
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <i class="fas fa-calendar mr-1"></i>
                                Fecha de Creación
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <i class="fas fa-cogs mr-1"></i>
                                Acciones
                            </th>
                        </tr>
                    </thead>
                    <tbody id="customersTable" class="bg-white divide-y divide-gray-200">
                        {% for customer in customers %}
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-xs font-mono text-gray-900 bg-gray-100 px-2 py-1 rounded">
                                    {{ customer.id }}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0 h-8 w-8">
                                        <div class="h-8 w-8 rounded-full bg-stripe-500 flex items-center justify-center">
                                            <i class="fas fa-user text-white text-xs"></i>
                                        </div>
                                    </div>
                                    <div class="ml-3">
                                        <div class="text-sm font-medium text-gray-900">
                                            {{ customer.name|default:"Sin nombre" }}
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">
                                    {% if customer.email %}
                                        <a href="mailto:{{ customer.email }}" class="text-stripe-500 hover:text-stripe-600">
                                            {{ customer.email }}
                                        </a>
                                    {% else %}
                                        <span class="text-gray-400 italic">Sin email</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">
                                    {% if customer.phone %}
                                        <a href="tel:{{ customer.phone }}" class="text-gray-900 hover:text-stripe-500">
                                            {{ customer.phone }}
                                        </a>
                                    {% else %}
                                        <span class="text-gray-400 italic">Sin teléfono</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="text-sm text-gray-900 max-w-xs truncate" title="{{ customer.description|default:'Sin descripción' }}">
                                    {% if customer.description %}
                                        {{ customer.description }}
                                    {% else %}
                                        <span class="text-gray-400 italic">Sin descripción</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">
                                    {{ customer.created|date:"d/m/Y" }}
                                </div>
                                <div class="text-xs text-gray-500">
                                    {{ customer.created|date:"H:i" }}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                {% if customer.email %}
                                    <a href="{% url 'facturacion:cambiar_metodo_pago' customer_email=customer.email %}" 
                                       class="inline-flex items-center px-3 py-1 border border-transparent rounded-md shadow-sm text-xs font-medium text-white bg-stripe-500 hover:bg-stripe-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-stripe-500 transition-colors">
                                        <i class="fas fa-credit-card mr-1"></i>
                                        Cambiar método de pago
                                    </a>
                                {% else %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-md text-xs font-medium text-gray-500 bg-gray-100">
                                        <i class="fas fa-exclamation-triangle mr-1"></i>
                                        Sin email
                                    </span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% else %}
        <div class="text-center py-12">
            <div class="mx-auto h-12 w-12 text-gray-400">
                <i class="fas fa-users text-4xl"></i>
            </div>
            <h3 class="mt-4 text-sm font-medium text-gray-900">No hay clientes</h3>
            <p class="mt-2 text-sm text-gray-500">
                No se encontraron clientes que coincidan con los filtros aplicados.
            </p>
            <div class="mt-6">
                <button type="button" 
                        onclick="clearFilters()"
                        class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-stripe-500 hover:bg-stripe-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-stripe-500">
                    <i class="fas fa-times mr-2"></i>
                    Limpiar filtros
                </button>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Paginación -->
    {% if customers %}
    <div class="mt-8 bg-white rounded-lg shadow-sm border border-gray-200">
        <div class="px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <span class="text-sm text-gray-700">
                        Mostrando <span class="font-medium">{{ customers|length }}</span> cliente{{ customers|length|pluralize:"s" }}
                    </span>
                    {% if has_more %}
                        <span class="text-sm text-gray-500">
                            (hay más disponibles)
                        </span>
                    {% endif %}
                </div>
                
                <div class="flex items-center space-x-3">
                    <button 
                        type="button" 
                        id="prevBtn" 
                        onclick="loadPage('prev')"
                        {% if not prev_ending_before %}disabled{% endif %}
                        class="inline-flex items-center px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-stripe-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                    >
                        <i class="fas fa-chevron-left mr-2"></i>
                        Anterior
                    </button>
                    
                    <span class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700">
                        <i class="fas fa-layer-group mr-2"></i>
                        Página {{ current_page }}
                    </span>
                    
                    <button 
                        type="button" 
                        id="nextBtn" 
                        onclick="loadPage('next')"
                        {% if not has_more %}disabled{% endif %}
                        class="inline-flex items-center px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-stripe-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                    >
                        Siguiente
                        <i class="fas fa-chevron-right ml-2"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentStartingAfter = '{{ next_starting_after|default:"" }}';
    let currentEndingBefore = '{{ prev_ending_before|default:"" }}';
    
    function loadPage(direction) {
        const form = document.getElementById('filterForm');
        const formData = new FormData(form);
        
        // Agregar parámetros de paginación
        if (direction === 'next' && currentStartingAfter) {
            formData.append('starting_after', currentStartingAfter);
        }
        
        // Mostrar loading
        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('customersContainer').classList.add('opacity-50');
        
        // Construir URL con parámetros
        const params = new URLSearchParams(formData);
        const url = `${window.location.pathname}?${params}`;
        
        // Hacer petición AJAX
        fetch(url, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showError(data.error + (data.details ? ': ' + data.details : ''));
                return;
            }
            
            // Actualizar tabla
            updateCustomersTable(data.customers);
            
            // Actualizar controles de paginación
            currentStartingAfter = data.next_starting_after || '';
            document.getElementById('nextBtn').disabled = !data.has_more;
            
            // Ocultar loading
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('customersContainer').classList.remove('opacity-50');
        })
        .catch(error => {
            console.error('Error:', error);
            showError('Error al cargar los clientes');
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('customersContainer').classList.remove('opacity-50');
        });
    }
    
    function updateCustomersTable(customers) {
        const tbody = document.getElementById('customersTable');
        tbody.innerHTML = '';
        
        customers.forEach(customer => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50 transition-colors';
            
            const createdDate = new Date(customer.created * 1000);
            const formattedDate = createdDate.toLocaleDateString('es-ES');
            const formattedTime = createdDate.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-xs font-mono text-gray-900 bg-gray-100 px-2 py-1 rounded">
                        ${customer.id}
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 h-8 w-8">
                            <div class="h-8 w-8 rounded-full bg-stripe-500 flex items-center justify-center">
                                <i class="fas fa-user text-white text-xs"></i>
                            </div>
                        </div>
                        <div class="ml-3">
                            <div class="text-sm font-medium text-gray-900">
                                ${customer.name || 'Sin nombre'}
                            </div>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">
                        ${customer.email ? 
                            `<a href="mailto:${customer.email}" class="text-stripe-500 hover:text-stripe-600">${customer.email}</a>` : 
                            '<span class="text-gray-400 italic">Sin email</span>'
                        }
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">
                        ${customer.phone ? 
                            `<a href="tel:${customer.phone}" class="text-gray-900 hover:text-stripe-500">${customer.phone}</a>` : 
                            '<span class="text-gray-400 italic">Sin teléfono</span>'
                        }
                    </div>
                </td>
                <td class="px-6 py-4">
                    <div class="text-sm text-gray-900 max-w-xs truncate" title="${customer.description || 'Sin descripción'}">
                        ${customer.description || '<span class="text-gray-400 italic">Sin descripción</span>'}
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${formattedDate}</div>
                    <div class="text-xs text-gray-500">${formattedTime}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    ${customer.email ? 
                        `<a href="/facturacion/cliente/${encodeURIComponent(customer.email)}/cambiar-metodo-pago/" 
                           class="inline-flex items-center px-3 py-1 border border-transparent rounded-md shadow-sm text-xs font-medium text-white bg-stripe-500 hover:bg-stripe-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-stripe-500 transition-colors">
                            <i class="fas fa-credit-card mr-1"></i>
                            Cambiar método de pago
                        </a>` : 
                        `<span class="inline-flex items-center px-3 py-1 rounded-md text-xs font-medium text-gray-500 bg-gray-100">
                            <i class="fas fa-exclamation-triangle mr-1"></i>
                            Sin email
                        </span>`
                    }
                </td>
            `;
            tbody.appendChild(row);
        });
    }
    
    function clearFilters() {
        const form = document.getElementById('filterForm');
        form.querySelector('input[name="email"]').value = '';
        form.querySelector('select[name="limit"]').value = '10';
        form.submit();
    }
    
    function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        const errorText = errorDiv.querySelector('p');
        errorText.textContent = message;
        errorDiv.classList.remove('hidden');
        setTimeout(() => {
            errorDiv.classList.add('hidden');
        }, 5000);
    }
</script>
{% endblock %}