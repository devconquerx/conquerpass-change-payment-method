{% extends "customer_base.html" %}

{% block title %}Cambiar Método de Pago - ConquerPass{% endblock %}

{% block content %}
<div class="px-4 sm:px-6 lg:px-8">
    <div class="max-w-2xl mx-auto">
        <!-- Contenido completo que se oculta en éxito -->
        <div id="main-content">
            <!-- Header -->
            <div class="mb-8 text-center">
                <h1 class="text-3xl font-bold text-gray-900">
                    <i class="fas fa-credit-card text-black mr-3"></i>
                    Configurar Método de Pago
                </h1>
                <p class="mt-3 text-lg text-gray-600">
                    Agrega un nuevo método de pago de forma segura
                </p>
            </div>

            <!-- Información del cliente y método de pago actual -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-8">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-info-circle text-blue-400"></i>
                    </div>
                    <div class="ml-3">
                        <div class="text-sm font-medium text-blue-800">
                            Configurando método de pago para: <strong>{{ customer.name|default:customer_email }}</strong>
                            {% if customer.name and customer_email %}
                                <br><span class="font-normal">{{ customer_email }}</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Información del método de pago actual -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden mb-6">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">
                        <i class="fas fa-credit-card text-gray-400 mr-2"></i>
                        Método de Pago Actual
                    </h3>
                </div>
                <div class="px-6 py-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-sm font-medium text-gray-900">
                                {{ current_payment_info.display_name }}
                            </div>
                            {% if current_payment_info.latest_order_id %}
                                <div class="text-sm text-gray-500">
                                    Última orden: #{{ current_payment_info.latest_order_id }}
                                    {% if current_payment_info.latest_order_date %}
                                        - {{ current_payment_info.latest_order_date|date:"d/m/Y" }}
                                    {% endif %}
                                </div>
                            {% endif %}
                            <div class="text-sm text-gray-500 mt-1">
                                Total de órdenes: {{ current_payment_info.orders_count.total }}
                                {% if current_payment_info.orders_count.stripe > 0 %}
                                    | Stripe: {{ current_payment_info.orders_count.stripe }}
                                {% endif %}
                                {% if current_payment_info.orders_count.dlocal > 0 %}
                                    | dLocal: {{ current_payment_info.orders_count.dlocal }}
                                {% endif %}
                            </div>
                        </div>
                        <div class="flex-shrink-0">
                            {% if primary_payment_method == 'stripe' %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                    <i class="fas fa-credit-card mr-1"></i>
                                    Stripe
                                </span>
                            {% elif primary_payment_method == 'dlocal' %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                    <i class="fas fa-globe mr-1"></i>
                                    dLocal
                                </span>
                            {% else %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                    <i class="fas fa-question-circle mr-1"></i>
                                    {{ primary_payment_method|title }}
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            {% if can_change_payment %}
                <!-- Card principal - Formulario de cambio de método de pago -->
                <div class="bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden">
                    <div class="px-6 py-6">

                        <!-- Error message (solo se muestra si hay error) -->
                        <div id="error-message" class="hidden rounded-md bg-red-50 border border-red-200 p-4 mb-6">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-exclamation-triangle text-red-400"></i>
                                </div>
                                <div class="ml-3">
                                    <h3 class="text-sm font-medium text-red-800">Error</h3>
                                    <div class="text-sm text-red-700 mt-1" id="error-text"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Formulario de método de pago -->
                        <form id="payment-form">
                            <div class="mb-6">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-credit-card mr-2 text-gray-400"></i>
                                    Información de la tarjeta
                                </label>
                                <div class="border border-gray-300 rounded-md p-4 bg-white focus-within:ring-1 focus-within:ring-black focus-within:border-black" style="min-height: 50px;">
                                    <!-- Stripe Elements se montará aquí -->
                                    <div id="card-element">
                                        <!-- Stripe Elements creará los inputs aquí -->
                                    </div>
                                </div>
                                <div class="mt-2 text-sm text-gray-500 flex items-center">
                                    <i class="fas fa-lock mr-2 text-green-500"></i>
                                    Tu información de pago está segura y encriptada
                                </div>
                            </div>

                            <!-- Errores de validación de tarjeta -->
                            <div id="card-errors" class="text-red-600 text-sm mb-4" role="alert"></div>

                            <div class="mt-6">
                                <button type="submit" id="submit-button" class="w-full flex justify-center items-center px-6 py-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-black hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-black transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                    <i class="fas fa-plus-circle mr-3"></i>
                                    <span id="button-text">Configurar Método de Pago</span>
                                    <div id="spinner" class="hidden ml-3">
                                        <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                                    </div>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            {% else %}
                <!-- Mensaje para usuarios de dLocal -->
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-yellow-800">
                                No se puede cambiar el método de pago
                            </h3>
                            <div class="mt-2 text-sm text-yellow-700">
                                <p>Tu cuenta utiliza dLocal como método de pago. En este momento no es posible cambiar a Stripe desde esta interfaz.</p>
                                {% if dlocal_info %}
                                    <p class="mt-2">{{ dlocal_info }}</p>
                                {% endif %}
                                <p class="mt-2">Si necesitas cambiar tu método de pago, por favor contacta con el soporte técnico.</p>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}

            <!-- Información adicional -->
            <div class="mt-6 bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">
                        <i class="fas fa-info-circle text-gray-400 mr-2"></i>
                        Información de Seguridad
                    </h3>
                </div>
                <div class="px-6 py-4">
                    <div class="space-y-3">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <i class="fas fa-shield-alt text-green-500 mt-1"></i>
                            </div>
                            <div class="ml-3">
                                <div class="text-sm font-medium text-gray-900">Procesamiento Seguro</div>
                                <div class="text-sm text-gray-500">Todos los datos son procesados por Stripe con encriptación SSL de nivel bancario</div>
                            </div>
                        </div>
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <i class="fas fa-credit-card text-blue-500 mt-1"></i>
                            </div>
                            <div class="ml-3">
                                <div class="text-sm font-medium text-gray-900">Tarjetas Aceptadas</div>
                                <div class="text-sm text-gray-500">Visa, Mastercard, American Express y más</div>
                            </div>
                        </div>
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <i class="fas fa-ban text-yellow-500 mt-1"></i>
                            </div>
                            <div class="ml-3">
                                <div class="text-sm font-medium text-gray-900">Sin Cargos</div>
                                <div class="text-sm text-gray-500">Solo se guardará el método de pago, no se realizará ningún cobro</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mensaje de éxito (solo se muestra en éxito) -->
        <div id="success-message" class="hidden">
            <div class="text-center py-16">
                <div class="max-w-lg mx-auto">
                    <div class="rounded-full bg-green-100 w-24 h-24 flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-check-circle text-4xl text-green-500"></i>
                    </div>
                    <h2 class="text-3xl font-bold text-gray-900 mb-4">
                        ¡Método de pago actualizado!
                    </h2>
                    <p class="text-lg text-gray-600 mb-8">
                        El nuevo método de pago se ha configurado correctamente y establecido como predeterminado para tu cuenta.
                    </p>
                    <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                        <div class="flex items-center justify-center">
                            <div class="flex-shrink-0">
                                <i class="fas fa-shield-alt text-green-500"></i>
                            </div>
                            <div class="ml-3 text-sm text-green-800">
                                Tu información de pago está segura y lista para usar
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{% if can_change_payment %}
<script src="https://js.stripe.com/v3/"></script>
<script>
    // Configuración de Stripe
    const stripe = Stripe('{{ stripe_publishable_key }}');
    const elements = stripe.elements();

    // Crear elemento de tarjeta
    const cardElement = elements.create('card', {
        style: {
            base: {
                fontSize: '16px',
                color: '#424770',
                '::placeholder': {
                    color: '#aab7c4',
                },
                fontFamily: 'system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto',
            },
            invalid: {
                color: '#9e2146',
            },
        },
        hidePostalCode: false
    });

    // Montar el elemento en el DOM
    cardElement.mount('#card-element');

    // Manejar errores en tiempo real
    cardElement.on('change', ({ error }) => {
        const displayError = document.getElementById('card-errors');
        if (error) {
            displayError.textContent = error.message;
        } else {
            displayError.textContent = '';
        }
    });

    // Manejar el envío del formulario
    const form = document.getElementById('payment-form');
    const submitButton = document.getElementById('submit-button');
    const buttonText = document.getElementById('button-text');
    const spinner = document.getElementById('spinner');

    form.addEventListener('submit', async (event) => {
        event.preventDefault();

        setLoading(true);

        const { setupIntent, error } = await stripe.confirmCardSetup(
            '{{ setup_intent_client_secret }}',
            {
                payment_method: {
                    card: cardElement,
                }
            }
        );

        if (error) {
            // Personalizar mensaje de error según el tipo
            let errorMessage = error.message;
            if (error.type === 'card_error') {
                if (error.code === 'card_declined') {
                    errorMessage = 'Tu tarjeta fue rechazada. Por favor, verifica los datos o intenta con otra tarjeta.';
                } else if (error.code === 'incorrect_cvc') {
                    errorMessage = 'El código de seguridad (CVC) es incorrecto. Por favor, verifica el número de 3 dígitos en el reverso de tu tarjeta.';
                } else if (error.code === 'expired_card') {
                    errorMessage = 'Tu tarjeta ha expirado. Por favor, intenta con una tarjeta válida.';
                } else if (error.code === 'incorrect_number') {
                    errorMessage = 'El número de tarjeta es incorrecto. Por favor, verifica los dígitos e intenta nuevamente.';
                }
            } else if (error.type === 'validation_error') {
                errorMessage = 'Por favor, completa todos los campos de la tarjeta correctamente.';
            }
            
            showError(errorMessage);
            setLoading(false);
        } else {
            // Setup Intent confirmado exitosamente
            console.log('Setup Intent confirmado:', setupIntent);
            
            // Notificar al servidor sobre el éxito
            try {
                const response = await fetch('{% url "payment_method:cambiar_metodo_pago" encrypted_email=encrypted_email %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        setup_intent_id: setupIntent.id
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showSuccess();
                } else {
                    showError(result.error);
                }
            } catch (fetchError) {
                showError('No pudimos conectar con el servidor. Por favor, verifica tu conexión a internet e intenta nuevamente.');
                console.error('Error:', fetchError);
            }
            
            setLoading(false);
        }
    });

    function setLoading(isLoading) {
        if (isLoading) {
            submitButton.disabled = true;
            buttonText.textContent = 'Procesando...';
            spinner.classList.remove('hidden');
        } else {
            submitButton.disabled = false;
            buttonText.textContent = 'Configurar Método de Pago';
            spinner.classList.add('hidden');
        }
    }

    function showError(message) {
        const errorDiv = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const successDiv = document.getElementById('success-message');
        
        successDiv.classList.add('hidden');
        errorText.textContent = message;
        errorDiv.classList.remove('hidden');
        
        // Scroll al error
        errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function showSuccess() {
        const errorDiv = document.getElementById('error-message');
        const successDiv = document.getElementById('success-message');
        const mainContent = document.getElementById('main-content');
        
        // Ocultar mensaje de error si está visible
        errorDiv.classList.add('hidden');
        
        // Ocultar todo el contenido principal
        mainContent.classList.add('hidden');
        
        // Mostrar mensaje de éxito
        successDiv.classList.remove('hidden');
        
        // Scroll al éxito
        successDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
</script>
{% endif %}
{% endblock %}